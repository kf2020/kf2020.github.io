---
  title: "320 Final Project"
author: "Amy, Katie, Shawdi"
date: "5/11/2019"
output: html_document
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stringr)
```

## R Markdown


```{r message=FALSE, warning=FALSE}
library(rvest)
library(tidyverse)
url <-"html_top100.txt"
college_urls <- url %>%
  read_html() %>%
  html_node("body") %>% html_nodes("ol[class~=bEyEue]") %>% html_nodes("li[id]")%>% html_nodes("h3") %>% 
  html_nodes("a[href]") %>%
  html_attr("href") 
college_urls

```


```{r message=FALSE, warning=FALSE}
index_num <- 0

college_tab_1 <-  data.frame("URL" = gsub(" ", "", paste("https://www.usnews.com",college_urls, sep = "")), 
"CollegeName"= "", "TuitionFeesThousands" = 0, "RoomBoardThousands" = 0, "TotalEnrollment" = 0, "SchoolType" = "", "YearFounded" = 0, "Setting" = "", "Endowment2017Millions" = 0, "MedianStartingSalaryOfAlumniThousands" = 0, "Selectivity" = "", "Fall2017AcceptanceRate" = 0, "MalePercentage" = 0, "FourYearGraduationRate" = 0, stringsAsFactors = FALSE) 

college_tab_1 <- college_tab_1[-c(40),]

college_tab_1
```


```{r message=FALSE, warning=FALSE}
#Shawdi start here

#retrieves of vector of size three containing the Tuition&Fees, Room&Board, and total enrollment
get_info <- function(url_html){
  attr <- url_html %>% html_node("body") %>% html_nodes("div[id~=content-main]") %>%   
    html_nodes("section[class~=hero-stats-widget-stats]") %>%
    html_nodes("ul") %>% html_nodes("li") %>% html_nodes("strong")
}

#takes in a vector and index, and parses that information to a double
#ex: $47,263 -> 47263.0
get_tuition_rm <- function(info, num){
  a_1 <- info[num] %>%  html_text()
  tuition_rm <- 
    as.double(paste(substring(a_1, 2, str_locate(a_1, ",")[1] - 1), substring(a_1, str_locate(a_1, ",")[1] + 1, str_locate(a_1, " ")[1] - 1), sep=""))
  tuition_rm / 1000.0
}

#takes in a vector and parses the total enrollment information to a double
get_enrollment <- function(info){
  a_1 <- info[3] %>%  html_text()
  as.double(paste(substring(a_1, 1, str_locate(a_1, ",")[1] - 1), substring(a_1, str_locate(a_1, ",")[1] + 1), sep=""))
}

#gets the percentage of the majority gender at a certain university
get_percent <- function(url_html){
  attr <- url_html %>% html_node("body") %>% html_nodes("div[id~=content-main]") %>%   
    html_nodes("div[class~=block-normal]") %>% html_nodes("span[class~=distribution-breakdown__percentage]") %>% html_text()
  as.double(substring(attr, 1, str_locate(attr, "%")[1] - 1)) / 100.0
}

#retrieves the gender of the majority sex and parses the percentage to be in terms of males
get_gender_ratio <- function(url_html){
  attr <- url_html %>% html_node("body") %>% html_nodes("div[id~=content-main]") %>%   
    html_nodes("div[class~=block-normal]") %>% html_nodes("span[class~=distribution-breakdown__percentage-copy]") %>% html_text()
  attr <- sub("\n                    ","",attr)
  attr <- sub("\n                ","",attr)
  if (attr == "Female"){
    1 - get_percent(url_html)
  }else{
    get_percent(url_html)
  }
  
}

```


```{r, message=FALSE, warning = FALSE}
college_tab <- college_tab_1

for (i in 1:nrow(college_tab)){
  url_html <- college_tab[i,1] %>%read_html()
  college_tab[i,]$CollegeName <- url_html %>% html_node("body") %>% html_nodes("h1[class~=hero-heading]") %>% html_text()
  college_tab[i,]$TuitionFeesThousands <- get_tuition_rm(get_info(url_html), 1)
  college_tab[i,]$RoomBoardThousands <- get_tuition_rm(get_info(url_html), 2)
  college_tab[i,]$TotalEnrollment <- get_enrollment(get_info(url_html))
  college_tab[i,]$MalePercentage <- get_gender_ratio(url_html)
  college_tab[i,]$Fall2017AcceptanceRate <- url_html %>% html_node("span[data-test-id~=r_c_accept_rate]") %>% html_text()
  college_tab[i,]$Selectivity <- url_html %>% html_node("span[data-test-id~=c_select_class]") %>% html_text()
  college_tab[i,]$FourYearGraduationRate <- url_html %>% html_node("span[data-test-id~=grad_rate_4_year]") %>% html_text()
  college_tab[i,]$MedianStartingSalaryOfAlumniThousands <-  url_html %>% html_nodes("div[data-field-id=averageStartSalary]") %>%html_node("span[data-test-id]") %>% html_text()
  temp_vector <- url_html %>% html_node("body") %>% html_nodes("div[id~=content-main]") %>%html_nodes("div[class~=flex-row]") %>%   html_nodes("span[class~=heading-small]") %>% html_text()
  college_tab[i,]$SchoolType <- temp_vector[1]
  college_tab[i,]$YearFounded <- temp_vector[2]
  college_tab[i,]$Setting <- temp_vector[5]
  college_tab[i,]$Endowment2017Millions  <- temp_vector[6]
}

college_tab
```


```{r formatting}
formatted_college_tab <- college_tab
#fix type of School Type, Setting, Year Founded
formatted_college_tab$SchoolType <- as.factor(formatted_college_tab$SchoolType)
formatted_college_tab$Setting <- as.factor(formatted_college_tab$Setting)
formatted_college_tab$YearFounded <- as.integer(formatted_college_tab$YearFounded)
#fix Endowment2017 formatting
formatted_college_tab$Endowment2017Millions  <- ifelse(grepl("billion", formatted_college_tab$Endowment2017Millions ), sub("\\.","",formatted_college_tab$Endowment2017Millions ),formatted_college_tab$Endowment2017Millions )
formatted_college_tab$Endowment2017Millions  <-sub(" billion","00",formatted_college_tab$Endowment2017Millions )
formatted_college_tab$Endowment2017Millions  <-sub(" million","",formatted_college_tab$Endowment2017Millions )

formatted_college_tab$Endowment2017Millions  <-sub("[[:punct:]]", "",formatted_college_tab$Endowment2017Millions )
formatted_college_tab$Endowment2017Millions  <-sub("\\$", "",formatted_college_tab$Endowment2017Millions )

formatted_college_tab$Endowment2017Millions  <-sub(" \\+", "",formatted_college_tab$Endowment2017Millions )
#fix College Name formatting
formatted_college_tab$CollegeName <- sub("^\n        ","",formatted_college_tab$CollegeName)
formatted_college_tab$CollegeName <-sub("\n    ","",formatted_college_tab$CollegeName)
#fixing Acceptance Rate formatting
formatted_college_tab$Fall2017AcceptanceRate <- sub("\n            ","",formatted_college_tab$Fall2017AcceptanceRate)
formatted_college_tab$Fall2017AcceptanceRate <- sub("%","",formatted_college_tab$Fall2017AcceptanceRate)
formatted_college_tab$Fall2017AcceptanceRate <- as.double(formatted_college_tab$Fall2017AcceptanceRate)
formatted_college_tab$Fall2017AcceptanceRate <- formatted_college_tab$Fall2017AcceptanceRate/100
#fixing Grad Rate formatting
formatted_college_tab$FourYearGraduationRate <- sub("\n            ","",formatted_college_tab$FourYearGraduationRate)
formatted_college_tab$FourYearGraduationRate <- sub("%","",formatted_college_tab$FourYearGraduationRate)
formatted_college_tab$FourYearGraduationRate <- as.double(formatted_college_tab$FourYearGraduationRate)
formatted_college_tab$FourYearGraduationRate <- formatted_college_tab$FourYearGraduationRate/100
#fixing Salary formatting
formatted_college_tab$MedianStartingSalaryOfAlumniThousands <- 
  sub("\n            ","",formatted_college_tab$MedianStartingSalaryOfAlumniThousands)
formatted_college_tab$MedianStartingSalaryOfAlumniThousands <- gsub("\\*","",formatted_college_tab$MedianStartingSalaryOfAlumniThousands)
formatted_college_tab$MedianStartingSalaryOfAlumniThousands <- gsub("\\$","",formatted_college_tab$MedianStartingSalaryOfAlumniThousands)
formatted_college_tab$MedianStartingSalaryOfAlumniThousands <- gsub("\\,","",formatted_college_tab$MedianStartingSalaryOfAlumniThousands)
formatted_college_tab$MedianStartingSalaryOfAlumniThousands <- as.double(formatted_college_tab$MedianStartingSalaryOfAlumniThousands)/1000
#fixing Selectivity formatting
formatted_college_tab$Selectivity <- sub("\n            ","",formatted_college_tab$Selectivity)
formatted_college_tab$Selectivity <- as.factor(formatted_college_tab$Selectivity)

formatted_college_tab <- formatted_college_tab %>% mutate(TotalCostThousands =TuitionFeesThousands + RoomBoardThousands )

formatted_college_tab
```

```{r}
formatted_college_tab$Endowment2017Millions  <- ifelse(grepl("billion", formatted_college_tab$Endowment2017Millions ), sub("\\.","",college_tab$Endowment2017Millions ),formatted_college_tab$Endowment2017Millions )
formatted_college_tab$Endowment2017Millions  <-sub(" billion","00",formatted_college_tab$Endowment2017Millions )
formatted_college_tab$Endowment2017Millions  <-sub(" million","",formatted_college_tab$Endowment2017Millions )

formatted_college_tab$Endowment2017Millions  <-sub("[[:punct:]]", "",formatted_college_tab$Endowment2017Millions )
formatted_college_tab$Endowment2017Millions  <-sub("\\$", "",formatted_college_tab$Endowment2017Millions )

formatted_college_tab$Endowment2017Millions  <-sub(" \\+", "",formatted_college_tab$Endowment2017Millions )
formatted_college_tab$Endowment2017Millions
```







#r EDAvisualization
```{r fig1, fig.height = 10, fig.width = 12}
#Starting Salary
#-histograms
library(ggplot2)
plot_1 <- formatted_college_tab %>%
  ggplot(aes(MedianStartingSalaryOfAlumniThousands)) +
    geom_histogram()+ 
    labs(title="Starting Salary Distribution", x="Median Starting Salary of Alumni (Thousands)", y="Count")
plot_1

```

The distribution of the median starting salary of alumni from all the school seems to be a bell-shaped curve, centering around $55,000.



```{r fig2, fig.height = 10, fig.width = 12}

#Tuition Cost
#-histograms
library(ggplot2)
plot_2 <- formatted_college_tab %>%
  ggplot(aes(TuitionFeesThousands)) +
    geom_histogram()+ 
        labs(title="Tuition Cost Distribution", x="Tuition Cost (Thousands)", y="Count")
plot_2

```

The distribution of tution costs of all the schools is bimodal, with a range of $60,000. 

```{r fig3, fig.height = 10, fig.width = 12}
#Acceptance rate vs graduation rate

library(ggplot2)
plot_3 <- formatted_college_tab %>%
  ggplot(aes(x=Fall2017AcceptanceRate, y=FourYearGraduationRate)) +
    geom_point()+ 
    geom_smooth(method=lm)+
        labs(title="Acceptance Vs. Graduation Rate", x="Fall 2017 Acceptance Rate", y="Four Year Graduation Rate")
plot_3
```
There is a linear relationship between acceptance rate (Fall 2017) and the four year graduation rate. It is an overall negative relationship. The more selective, the lower the rate of graduation. 


```{r fig4, fig.height = 10, fig.width = 12}
#Boxplots of (1) gradrate & (2) admission rate by selectivity 

library(ggplot2)
plot_4 <- formatted_college_tab %>%
  ggplot(aes(x=Selectivity, y=FourYearGraduationRate)) +
    geom_boxplot()+
        labs(title="Graduation Rate based on Selectivity", x="Selectivity Level", y="Four Year Graduation Rate")
plot_4

```
This is significant difference in four year graduation rates based on their Selectivity Level of accepting students. These boxplots show that each 3 selectivity level vary significantly on range and central tendency. The more selective a college is, the greater their graduation rates seem to be. 

```{r fig5, fig.height = 10, fig.width = 12}
#Setting vs. room board

library(ggplot2)
plot_5 <- formatted_college_tab %>%
  ggplot(aes(x=Setting, y=RoomBoardThousands)) +
    geom_boxplot()+
        labs(title="Setting vs. Room & Board Costs", x="Setting", y="Room & Board Costs (Thousands)")
plot_5

```
The boxplots of room & board costs based on setting shows that the setting of the college does influence the room and board costs for the students. The medians vary greatly. The interquartile spreads seems to be similar while the overall ranges vary.

```{r fig6, fig.height = 10, fig.width = 12}
plot_6 <- formatted_college_tab %>%
  ggplot(aes(x=TotalCostThousand, y=MedianStartingSalaryOfAlumniThousands)) +
    geom_point()+ 
    geom_smooth(method=lm)+
        labs(title="Total Cost vs. Median Starting Salary", x="Total Cost (Thousand)", y="Median Starting Salary Of Alumni (Thousands)")
plot_6
```

There appears to be a positive linear relatinoship between median starting salary and total cost of colleges. The general trends shows that the more students spend on tution and room & board, the more likely that their starting salary is higher. 

```{r fig7, fig.height = 10, fig.width = 12}
plot_7 <- formatted_college_tab %>%
  ggplot(aes(x=SchoolType, y=MedianStartingSalaryOfAlumniThousands  
)) +
    geom_boxplot()+
        labs(title="Median Starting Salary Of Alumni Based on School Type  ", x="School Type", y="Median Starting Salary Of Alumni (Thousands)")
plot_7
```
Between school types, private colleges seem to have greater starting salaries than public schools, based on the medians of these boxplots. 
```{r}
 formatted_college_tab %>% group_by(Selectivity) %>%
  summarise(n())
```



